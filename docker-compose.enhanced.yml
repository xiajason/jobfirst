services:
  # Redis 缓存服务
  redis:
    image: redis:7-alpine
    container_name: jobfirst-redis
    ports:
      - "8201:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    networks:
      - jobfirst-network

  # MySQL 数据库服务 - 核心业务数据
  mysql:
    image: mysql:8.0
    container_name: jobfirst-mysql
    ports:
      - "8200:3306"
    environment:
      MYSQL_ROOT_PASSWORD: jobfirst123
      MYSQL_DATABASE: jobfirst
      MYSQL_USER: jobfirst
      MYSQL_PASSWORD: jobfirst123
    volumes:
      - mysql_data:/var/lib/mysql
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    command: --default-authentication-plugin=mysql_native_password
    networks:
      - jobfirst-network

  # PostgreSQL 数据库服务 - AI模型和高级配置
  postgresql:
    image: postgres:15
    container_name: jobfirst-postgresql
    ports:
      - "8203:5432"
    environment:
      POSTGRES_DB: jobfirst_advanced
      POSTGRES_USER: jobfirst
      POSTGRES_PASSWORD: jobfirst123
    volumes:
      - postgresql_data:/var/lib/postgresql/data
    networks:
      - jobfirst-network

  # Neo4j 图数据库服务 - 关系分析和智能推荐
  neo4j:
    image: neo4j:5.15
    container_name: jobfirst-neo4j
    ports:
      - "8204:7474"  # HTTP
      - "8205:7687"  # Bolt
    environment:
      NEO4J_AUTH: neo4j/jobfirst123
      NEO4J_PLUGINS: '["apoc", "graph-data-science"]'
      NEO4J_dbms_security_procedures_unrestricted: apoc.*,gds.*
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
      - neo4j_import:/var/lib/neo4j/import
      - neo4j_plugins:/plugins
    networks:
      - jobfirst-network

  # Consul 服务发现和配置中心
  consul:
    image: consul:1.15
    container_name: jobfirst-consul
    ports:
      - "8202:8500"
      - "8206:8600/udp"
    volumes:
      - consul_data:/consul/data
    command: consul agent -server -bootstrap-expect=1 -ui -client=0.0.0.0 -data-dir=/consul/data
    networks:
      - jobfirst-network

  # API Gateway 网关服务
  gateway:
    build:
      context: ./backend/gateway
      dockerfile: Dockerfile
    container_name: jobfirst-gateway
    ports:
      - "8080:8080"
    depends_on:
      - redis
      - consul
      - mysql
      - postgresql
      - neo4j
    environment:
      - CONSUL_ADDRESS=consul:8500
      - REDIS_ADDRESS=redis:6379
      - MYSQL_ADDRESS=mysql:3306
      - POSTGRESQL_ADDRESS=postgresql:5432
      - NEO4J_ADDRESS=neo4j:7687
    volumes:
      - ./backend/gateway/config.yaml:/root/config/config.yaml
    networks:
      - jobfirst-network

  # User Service 用户服务
  user:
    build:
      context: ./backend
      dockerfile: user/Dockerfile
    container_name: jobfirst-user
    ports:
      - "8081:8081"
    depends_on:
      - redis
      - consul
      - mysql
      - neo4j
    environment:
      - CONSUL_ADDRESS=consul:8500
      - REDIS_ADDRESS=redis:6379
      - MYSQL_ADDRESS=mysql
      - MYSQL_USER=jobfirst
      - MYSQL_PASSWORD=jobfirst123
      - MYSQL_DATABASE=jobfirst
      - NEO4J_ADDRESS=neo4j:7687
      - NEO4J_USER=jobfirst
      - NEO4J_PASSWORD=jobfirst123
    networks:
      - jobfirst-network

  # Resume Service 简历服务
  resume:
    build:
      context: ./backend
      dockerfile: resume/Dockerfile
    container_name: jobfirst-resume
    ports:
      - "8087:8082"
    depends_on:
      - redis
      - consul
      - mysql
      - neo4j
    environment:
      - CONSUL_ADDRESS=consul:8500
      - REDIS_ADDRESS=redis:6379
      - MYSQL_ADDRESS=mysql
      - MYSQL_USER=jobfirst
      - MYSQL_PASSWORD=jobfirst123
      - MYSQL_DATABASE=jobfirst
      - NEO4J_ADDRESS=neo4j:7687
      - NEO4J_USER=jobfirst
      - NEO4J_PASSWORD=jobfirst123
    networks:
      - jobfirst-network

  # AI Service AI服务
  ai:
    build:
      context: ./backend/ai-service
      dockerfile: Dockerfile
    container_name: jobfirst-ai
    ports:
      - "8089:8089"
    depends_on:
      - redis
      - consul
      - postgresql
      - neo4j
    environment:
      - CONSUL_ADDRESS=consul:8500
      - REDIS_ADDRESS=redis:6379
      - POSTGRESQL_ADDRESS=postgresql:5432
      - POSTGRESQL_USER=jobfirst
      - POSTGRESQL_PASSWORD=jobfirst123
      - POSTGRESQL_DATABASE=jobfirst_advanced
      - NEO4J_ADDRESS=neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=jobfirst123
    networks:
      - jobfirst-network

  # Statistics Service 统计服务
  statistics:
    build:
      context: ./backend
      dockerfile: statistics/Dockerfile
    container_name: jobfirst-statistics
    ports:
      - "8097:8085"
    depends_on:
      - redis
      - consul
      - mysql
      - postgresql
    environment:
      - CONSUL_ADDRESS=consul:8500
      - REDIS_ADDRESS=redis:6379
      - MYSQL_ADDRESS=mysql
      - MYSQL_USER=jobfirst
      - MYSQL_PASSWORD=jobfirst123
      - MYSQL_DATABASE=jobfirst
      - POSTGRESQL_ADDRESS=postgresql:5432
      - POSTGRESQL_USER=jobfirst
      - POSTGRESQL_PASSWORD=jobfirst123
      - POSTGRESQL_DATABASE=jobfirst_advanced
    networks:
      - jobfirst-network

  # Storage Service 存储服务
  storage:
    build:
      context: ./backend
      dockerfile: storage/Dockerfile
    container_name: jobfirst-storage
    ports:
      - "8088:8088"
    depends_on:
      - redis
      - consul
      - mysql
    environment:
      - CONSUL_ADDRESS=consul:8500
      - REDIS_ADDRESS=redis:6379
      - MYSQL_ADDRESS=mysql
      - MYSQL_USER=jobfirst
      - MYSQL_PASSWORD=jobfirst123
      - MYSQL_DATABASE=jobfirst
    volumes:
      - ./backend/storage/config.yaml:/root/config/config.yaml
      - storage_data:/data/files
    networks:
      - jobfirst-network

  # Points Service 积分服务
  points:
    build:
      context: ./backend
      dockerfile: points/Dockerfile
    container_name: jobfirst-points
    ports:
      - "8086:8083"
    depends_on:
      - redis
      - consul
      - mysql
    environment:
      - CONSUL_ADDRESS=consul:8500
      - REDIS_ADDRESS=redis:6379
      - MYSQL_ADDRESS=mysql
      - MYSQL_USER=jobfirst
      - MYSQL_PASSWORD=jobfirst123
      - MYSQL_DATABASE=jobfirst
    networks:
      - jobfirst-network

  # Frontend Web 前端Web应用
  web:
    build:
      context: ./frontend/web
      dockerfile: Dockerfile
    container_name: jobfirst-web
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://gateway:8080
    depends_on:
      - gateway
    networks:
      - jobfirst-network

volumes:
  redis_data:
  mysql_data:
  postgresql_data:
  neo4j_data:
  neo4j_logs:
  neo4j_import:
  neo4j_plugins:
  consul_data:
  storage_data:

networks:
  jobfirst-network:
    driver: bridge
